---
title: "Frog Growth"
author: "Roland Knapp"
date: "`r Sys.Date()`"
format: html
editor: source
---

This Quarto document extracts frog growth data from the MLRG amphibians database. Specifically, it extracts capture data for frogs at CMR sites that were captured at least twice and with captures separated in time by at least 30 days. For users without access to the database, the retrieved data are saved as .csv files. These files can be imported into R objects (e.g., tibbles) and used in subsequent code chunks. 

## Load packages
```{r}
librarian::shelf(RPostgres, readr, dplyr, tidyr, lubridate, ggplot2)
```

## Connect to database
```{r}
source("db_connect.R")
```

## Retrieve data from all CMR surveys
```{r}
visit <- tbl(con, Id("visit")) %>% 
  rename(visit_id = id)
survey <- tbl(con, Id("survey")) %>% 
  rename(survey_id = id)
capture_survey <- tbl(con, Id("capture_survey"))

capture_join <- visit %>% 
  inner_join(survey, by = "visit_id") %>% 
  inner_join(capture_survey, by = "survey_id") %>% 
  filter(survey_type == "cmr",
         capture_animal_state != "dead") %>% 
  collect()

capture_join <- capture_join %>% 
  select(site_id, visit_date, pit_tag_ref, tag_new, capture_animal_state, sex, length, weight) %>% 
  arrange(site_id, pit_tag_ref, visit_date)
```

## Retrieve data from relocate tables
```{r}
relocate <- tbl(con, Id("relocate")) %>% 
  rename(relocate_id = id)
relocate_frog <- tbl(con, Id("relocate_frog"))

relocate_join <- relocate %>% 
  left_join(relocate_frog, by = "relocate_id") %>% 
  collect()

relocate_join <- relocate_join %>% 
  select(collect_siteid, release_siteid1, release_siteid2, release_date, type, pit_tag_ref)

```

## Disconnect from database
```{r}
source("db_disconnect.R")
```

## Save retrieved data files
```{r}
write_csv(capture_join, here::here("data", "capture_join.csv"))
write_csv(relocate_join, here::here("data", "relocate_join.csv"))
```

## Select frogs with multiple captures across primary periods
```{r}
capture_join_dropna <- capture_join %>% 
  drop_na() # excludes multiple captures within a primary period

multiple_captures <- capture_join_dropna %>% 
  select(-tag_new, -capture_animal_state, -sex) %>% 
  count(pit_tag_ref) %>% 
  rename(captures = n) %>% 
  filter(captures > 1) %>% 
  inner_join(capture_join_dropna, by = "pit_tag_ref")
```

## Histogram of number of captures per frog
```{r}
multiple_captures %>% 
  distinct(pit_tag_ref, captures) %>% 
  ggplot(aes(x = captures)) +
    geom_histogram(binwidth = 1)
```

## Add population type (Bd naive, Bd treatment, recovery, translocated, reintroduced zoo-raised frogs, translocated-reintroduced) and frog type (resident-naturally recruited, translocated, reintroduced)
```{r}
# remove incorrect pit_tag_refs (to avoid many-to-many relationship, etc.)
relocate_join <- relocate_join %>% 
  filter(!(collect_siteid == "72996" & pit_tag_ref == "900067000117396")) %>% 
  filter(!(collect_siteid == "10055" & pit_tag_ref == "900043000217381"))

multiple_captures_join <- multiple_captures %>% 
  left_join(relocate_join, by = "pit_tag_ref")

# for error checking/fixing, split delimited string collect_siteid into columns
multiple_captures_join <- multiple_captures_join %>% 
  separate_wider_delim(collect_siteid, delim = ",", names = c("collect_siteid1", "collect_siteid2", "collect_siteid3"), too_few = "align_start")
```

## Fix errors
```{r}
# fix pit tags labeled as "translocation" or "reintroduction" for frogs that were tagged at one site and translocated months/years later to another site
# fix pit tags labeled as "translocation" for frog that was tagged at one site, listed as translocated, but recaptured after at original site
multiple_captures_join <- multiple_captures_join %>% 
  mutate(type = replace(type, type == "translocation" & 
                              (collect_siteid1 == site_id | collect_siteid2 == site_id | collect_siteid3 == site_id) & 
                              release_date >= visit_date, NA), 
         type = replace(type, type == "reintroduction" & 
                              (collect_siteid1 == site_id | collect_siteid2 == site_id | collect_siteid3 == site_id) & 
                              release_date >= visit_date, NA), 
         type = replace(type, type == "translocation" & pit_tag_ref == "091020125", NA))
multiple_captures_join <- multiple_captures_join %>%  
  mutate(type = na_if(type, "NA"))

# remove records where frogs were tagged in field, taken to lab for 3 months, then released back into field. Remove pre-release records. 
multiple_captures_join <- multiple_captures_join %>% 
  filter(!between(site_id, 10475, 10477))

# remove records where frogs were tagged in field and translocated, but not listed in relocate tables. Remove pre-release records.
multiple_captures_join <- multiple_captures_join %>% 
  filter(site_id != 50183)

# remove records where frogs were tagged in field and translocated, but tagging was done several years previously. Remove pre-release records.
multiple_captures_join <- multiple_captures_join %>% 
  filter(site_id != 70567)

# fix pit tags captured but not listed in relocate_frog and therefore don't have type in multiple_captures_join table - must be reintroduced frogs
multiple_captures_join <- multiple_captures_join %>% 
  mutate(type = replace(type, site_id == 10109, "reintroduction"),
         type = replace(type, site_id == 10114, "reintroduction"),
         type = replace(type, site_id == 10206, "reintroduction"),
         type = replace(type, site_id == 11896, "reintroduction"),
         type = replace(type, site_id == 70571, "reintroduction"))


sites <- multiple_captures_join %>% 
  distinct(site_id, type) %>% 
  mutate(code = case_when(!is.na(type) ~ 1)) %>% 
  pivot_wider(names_from = type, values_from = code) %>% 
  select(-"NA") %>% 
  mutate(population_type = case_when(translocation == 1 & is.na(reintroduction) ~ 1,
                                    reintroduction == 1 & is.na(translocation) ~ 2,
                                    translocation == 1 & reintroduction == 1 ~ 3)) %>% 
  arrange(site_id)

# Add other population types
translocated_reintroduced <- c(70114, 70175, 70279, 70413, 70611, 72008, 72093, 72442)   # 3
reintroduced_naive_declining <- c(10276, 10277, 10284, 10285, 10314, 10315, 10316, 10422, 11359, 11506, 12361, 12534, 20196, 20198, 20199)  # 7
translocated_naive <- c(10486, 50170, 50194, 50219)  # 4
bd_naive <- c(11008, 11009)   # 0
post_epizootic_declining <- c(72989, 74281, 12562)  # 5
bd_treatment <- c(10100, 10101, 10102, 11858, 12590, 12618, 12621, 50839)  # 6
recovery <- c(22019, 50783, 54188, 70355, 70399, 70442, 70627, 70650, 71362, 71679, 71811, 72021, 72336, 72808, 72849, 72996, 74060, 74061)  # 8

sites_join <- sites %>% 
  mutate(population_type1 = case_when(site_id %in% translocated_reintroduced ~ 3,
                                      site_id %in% reintroduced_naive_declining ~ 7,
                                      site_id %in% translocated_naive ~ 4,
                                      site_id %in% bd_naive ~ 0,
                                      site_id %in% post_epizootic_declining ~ 5,
                                      site_id %in% bd_treatment ~ 6,
                                      site_id %in% recovery ~ 8,
                                      .default = population_type))

```


Issues
- Multiple_captures_join: 10109, reintroduced frogs 900043000200536 and 900043000200591 are not in relocate_frog but should be.  
- Relocate tables: translocation from 50183 to 50194 not present. Move records of PIT tagged frogs from 50183 from capture table to relocate tables.
- Budd Lake (70571) reintroductions now listed in relocate tables
- Frogs translocated from 70215 to 70611 in 2022 are not listed in relocate table, nor are frogs reintroduced to 70611 in the same year. 
- PIT tag 900043000217381 shown as reintroduced to 10109 is likely incorrect. Same tag recorded twice at 70641. 

